#!/bin/bash

#
# Inspired by  https://github.com/ReproNim/containers/issues/137#issuecomment-2877505303
#
git annex find --in here | grep '\.si*' | while read -r f; do
    echo "D: testing $f"

    # Capture output and exit code
    output=$(singularity run "$f" --help 2>&1)
    exit_code=$?

    # Check execution success
    if [ $exit_code -eq 0 ]; then
        echo "$f: ok"
    else
        echo "$f: failed to execute --help" >&2
    fi

    # Check for "no runscript" message
    if echo "$output" | grep -q "no runscript"; then
        echo "$f: no runscript" >&2
    fi
done
