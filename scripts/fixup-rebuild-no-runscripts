#!/bin/bash
#
# Script to rebuild .sing images that have "no runscript" issues
# by pulling directly from Docker Hub, converting them to .sif format,
# and updating .datalad/config accordingly.
#
# The script extracts the Docker URI from the corresponding Singularity.*
# recipe file, pulls the image using 'singularity pull', sets git-annex
# metadata with the original-uri, and removes the now-unnecessary recipe file.
#
# Usage: fixup-rebuild-no-runscripts [-n|--dry-run] [LOG_FILE]
#
#   -n, --dry-run   Show what would be done without making changes
#   LOG_FILE        Path to duct stderr log file (default: most recent in .duct/logs/)
#

set -eu

# Parse arguments
DRY_RUN=0
STDERR_LOG=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -n|--dry-run)
            DRY_RUN=1
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            echo "Usage: $0 [-n|--dry-run] [LOG_FILE]" >&2
            exit 1
            ;;
        *)
            STDERR_LOG="$1"
            shift
            ;;
    esac
done

# Use local tmp directory for singularity builds (to have enough storage)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
TMPDIR="$REPO_DIR/tmp"
if [ "$DRY_RUN" -eq 0 ]; then
    mkdir -p "$TMPDIR"
fi
export SINGULARITY_TMPDIR="$TMPDIR"

# If no log file specified, find the most recent stderr log
if [ -z "$STDERR_LOG" ]; then
    DUCT_LOGS_DIR="$REPO_DIR/.duct/logs"
    if [ -d "$DUCT_LOGS_DIR" ]; then
        # shellcheck disable=SC2012
        STDERR_LOG=$(ls -t "$DUCT_LOGS_DIR"/*_stderr 2>/dev/null | head -1)
    fi
    if [ -z "$STDERR_LOG" ]; then
        echo "Error: No stderr log file found in $DUCT_LOGS_DIR" >&2
        exit 1
    fi
    echo "Using log file: $STDERR_LOG"
fi

DATALAD_CONFIG="$REPO_DIR/.datalad/config"

if [ ! -f "$STDERR_LOG" ]; then
    echo "Error: Log file not found: $STDERR_LOG" >&2
    exit 1
fi

if [ "$DRY_RUN" -eq 1 ]; then
    echo "=== DRY RUN MODE - No changes will be made ==="
    echo ""
fi

# Extract files with "no runscript" error
grep ": no runscript$" "$STDERR_LOG" | while IFS=: read -r sing_file _rest; do
    # sing_file is like "images/bids/bids-giga-connectome--0.6.0.sing"

    # Skip if file doesn't end with .sing
    if [[ ! "$sing_file" =~ \.sing$ ]]; then
        echo "Skipping non-.sing file: $sing_file"
        continue
    fi

    # Full path to the .sing file
    full_sing_path="$REPO_DIR/$sing_file"

    # Derive paths
    dir=$(dirname "$sing_file")
    base=$(basename "$sing_file" .sing)

    # New .sif file path
    sif_file="$dir/$base.sif"
    full_sif_path="$REPO_DIR/$sif_file"

    # Singularity recipe file (no extension, just Singularity.name--version)
    recipe_file="$REPO_DIR/$dir/Singularity.$base"

    echo "Processing: $sing_file"
    echo "  -> New SIF: $sif_file"
    echo "  -> Recipe: $recipe_file"

    # Check if recipe exists
    if [ ! -f "$recipe_file" ]; then
        echo "  WARNING: Recipe file not found: $recipe_file - skipping"
        continue
    fi

    # Extract the Docker URI from the recipe file's "From:" line
    # Format in file: "From: dockerhubid:version_tag"
    from_line=$(grep -E "^From:" "$recipe_file" | head -1)
    if [ -z "$from_line" ]; then
        echo "  WARNING: No 'From:' line found in $recipe_file - skipping"
        continue
    fi
    # Extract the image reference (e.g., "nipreps/fmriprep:25.2.3")
    # shellcheck disable=SC2001
    docker_image=$(echo "$from_line" | sed 's/^From:[[:space:]]*//')
    docker_uri="docker://$docker_image"
    echo "  -> Docker URI: $docker_uri"

    # Check if old .sing file exists (might need datalad get)
    if [ ! -f "$full_sing_path" ]; then
        echo "  NOTE: .sing file not present locally: $full_sing_path"
        echo "  Will still try to pull new .sif and update config"
    fi

    # Check if .sif already exists
    sif_exists=0
    if [ -f "$full_sif_path" ] || git ls-files --error-unmatch "$full_sif_path" 2>/dev/null; then
        sif_exists=1
        echo "  NOTE: .sif file already exists: $sif_file"
    fi

    # Pull new .sif image (or skip if exists)
    if [ "$DRY_RUN" -eq 1 ]; then
        if [ "$sif_exists" -eq 1 ]; then
            echo "  [DRY RUN] Would skip pull (.sif already exists)"
        else
            echo "  [DRY RUN] Would pull: singularity pull --disable-cache $full_sif_path $docker_uri"
            echo "  [DRY RUN] Would set metadata: git annex metadata --set original-uri='$docker_uri' $full_sif_path"
        fi

        # Check what config update would happen
        if grep -q "image = $sing_file" "$DATALAD_CONFIG"; then
            echo "  [DRY RUN] Would update .datalad/config: $sing_file -> $sif_file"
        else
            echo "  [DRY RUN] NOTE: $sing_file not found in .datalad/config (may not be registered)"
        fi

        # Check what git rm would happen for old .sing file
        if [ -f "$full_sing_path" ] || git ls-files --error-unmatch "$full_sing_path" 2>/dev/null; then
            echo "  [DRY RUN] Would remove: git rm -f $full_sing_path"
        else
            echo "  [DRY RUN] NOTE: Old .sing file not tracked in git"
        fi

        # Check what git rm would happen for recipe file
        if git ls-files --error-unmatch "$recipe_file" 2>/dev/null; then
            echo "  [DRY RUN] Would remove recipe: git rm $recipe_file"
        else
            echo "  [DRY RUN] Would remove recipe (untracked): rm $recipe_file"
        fi

        echo "  [DRY RUN] Done (no changes made)"
    else
        if [ "$sif_exists" -eq 1 ]; then
            echo "  Skipping pull (.sif already exists)"
        else
            echo "  Pulling new .sif image..."
            if singularity pull --disable-cache "$full_sif_path" "$docker_uri"; then
                echo "  Pull successful: $sif_file"

                # Set git-annex metadata with original URI
                echo "  Setting git-annex metadata..."
                git annex add "$full_sif_path"
                git annex metadata --set "original-uri=$docker_uri" "$full_sif_path"
                echo "  Metadata set: original-uri=$docker_uri"
            else
                echo "  ERROR: Pull failed for $sing_file" >&2
                exit 1
            fi
        fi

        # Update .datalad/config to use new .sif instead of .sing
        # The config has lines like: image = images/bids/bids-giga-connectome--0.6.0.sing
        if grep -q "image = $sing_file" "$DATALAD_CONFIG"; then
            echo "  Updating .datalad/config..."
            sed -i "s|image = $sing_file|image = $sif_file|g" "$DATALAD_CONFIG"
            echo "  Config updated: $sing_file -> $sif_file"
        else
            echo "  NOTE: $sing_file not found in .datalad/config (may not be registered)"
        fi

        # Remove old .sing file with git rm
        if [ -f "$full_sing_path" ] || git ls-files --error-unmatch "$full_sing_path" 2>/dev/null; then
            echo "  Removing old .sing file with git rm..."
            git rm -f "$full_sing_path"
        else
            echo "  NOTE: Old .sing file not tracked in git"
        fi

        # Remove the Singularity recipe file (no longer needed)
        echo "  Removing Singularity recipe file..."
        if git ls-files --error-unmatch "$recipe_file" 2>/dev/null; then
            git rm "$recipe_file"
        else
            rm "$recipe_file"
        fi
        echo "  Recipe file removed: $recipe_file"

        echo "  Done processing $sing_file"
    fi

    echo ""
done

echo "All done. Remember to:"
echo "  1. Review changes with 'git status' and 'git diff'"
echo "  2. Commit changes: git commit -m 'Convert images with no runscript to .sif via docker pull'"
echo "  3. Clean up tmp directory if no longer needed: rm -rf $TMPDIR"
